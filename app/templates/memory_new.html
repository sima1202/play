{% extends "base.html" %}
{% block content %}
<div style="max-width: 500px; margin: 0 auto; padding: 20px; font-family: 'Kiwi Maru', serif; color: #5d4037;">
  <h1 style="text-align: center; color: #4E7055;">ğŸƒ æ€ã„å‡ºã‚’è¨˜ã™</h1>

  <form method="POST" enctype="multipart/form-data">
    <div style="margin-bottom: 15px;">
      <label>æ€ã„å‡ºã®ã‚¿ã‚¤ãƒˆãƒ«</label><br>
      <input name="title" required value="{{ title }}" placeholder="ä¾‹ï¼šæœ€é«˜ã®ä¼‘æ—¥ï¼" style="width: 100%; padding: 10px; border: 1.5px solid #c8e6c9; border-radius: 8px; background: #fffdf9;">
    </div>

    <div style="margin-top: 10px;">
      <label>ã‚ã®æ—¥ã„ã¤ï¼Ÿ</label><br>
      <input name="date" type="date" value="2026-02-05" style="width: 100%; padding: 10px; border: 1.5px solid #c8e6c9; border-radius: 8px; background: #fffdf9;">
    </div>

    <div style="margin-top: 10px;">
      <label>ã©ã‚“ãªã“ã¨ãŒã‚ã£ãŸï¼Ÿ</label><br>
      <textarea name="note" rows="4" placeholder="æ¥½ã—ã‹ã£ãŸæ€ã„å‡ºã‚’è‡ªç”±ã«æ›¸ãã¾ã—ã‚‡ã†" style="width: 100%; padding: 10px; border: 1.5px solid #c8e6c9; border-radius: 8px; background: #fffdf9;"></textarea>
    </div>

    <div style="margin-top: 10px;">
      <label>å ´æ‰€ã®åå‰ (åº—åã‚„åœ°å)</label><br>
      <input id="shop_name_input" name="shop_name" value="{{ shop_name if shop_name else '' }}" placeholder="æ¸‹è°·é§…ã€æ±äº¬ã‚¿ãƒ¯ãƒ¼ãªã©" style="width: 100%; padding: 10px; border: 1.5px solid #c8e6c9; border-radius: 8px; background: #fffdf9;">
    </div>

    <input type="hidden" id="lat_input" name="lat" value="{{ lat if lat else '' }}">
    <input type="hidden" id="lng_input" name="lng" value="{{ lng if lng else '' }}">
    <input type="hidden" name="shop_url" value="{{ shop_url if shop_url else '' }}">

    <div style="margin-top: 15px;">
      <label>ã‚ã®æ—¥ã®ä¸€æš</label><br>
      <input id="imageInput" type="file" name="image" accept="image/*" style="font-size: 0.8rem;">
      <div style="margin-top: 10px; text-align: center;">
        <img id="preview" style="max-width: 100%; display: none; border-radius: 15px; border: 3px solid #f1f8e9; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
      </div>
    </div>

    <button type="button" onclick="handleSave()" id="saveBtn" style="margin-top: 30px; width: 100%; padding: 15px; background-color: #4E7055; color: white; border: none; border-radius: 50px; font-size: 18px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #2e4a34;">
      æ€ã„å‡ºã‚’ä¿å­˜ã™ã‚‹
    </button>
  </form>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places"></script>

<script>
function initMap() { console.log("Google Maps Ready!"); }

async function handleSave() {
    const shopNameInput = document.getElementById('shop_name_input');
    const latInput = document.getElementById('lat_input');
    const lngInput = document.getElementById('lng_input');
    const btn = document.getElementById('saveBtn');
    const form = document.querySelector('form');

    const locationName = shopNameInput.value.trim();

    if (!locationName) {
        alert("å ´æ‰€ã®åå‰ã‚’å…¥åŠ›ã—ã¦ã­ï¼ğŸƒ");
        return;
    }

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é€£æ‰“é˜²æ­¢
    btn.disabled = true;
    btn.innerText = "å ´æ‰€ã‚’æ¢ã—ã¦ã„ã¾ã™...";

    // ã™ã§ã«åº§æ¨™ãŒã‚ã‚‹å ´åˆã¯ãã®ã¾ã¾é€ä¿¡
    if (latInput.value && latInput.value !== "" && latInput.value !== "None") {
        form.submit();
        return;
    }

    // åº§æ¨™ãŒãªã„å ´åˆã€Googleã§æ¤œç´¢
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ address: locationName }, (results, status) => {
        if (status === "OK") {
            const loc = results[0].geometry.location;
            latInput.value = loc.lat();
            lngInput.value = loc.lng();
            form.submit();
        } else {
            alert("ã€Œ" + locationName + "ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚Googleå´ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚åŸå› : " + status);
            btn.disabled = false;
            btn.innerText = "æ€ã„å‡ºã‚’ä¿å­˜ã™ã‚‹";
        }
    });
}

// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
document.getElementById("imageInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    const preview = document.getElementById("preview");
    if (!file) { preview.style.display = "none"; return; }
    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";
});
</script>
{% endblock %}