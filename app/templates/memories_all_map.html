{% extends "base.html" %}
{% block content %}
<h2>My Memories Map ğŸ“¸</h2>
<p style="color: #666;">ã“ã‚Œã¾ã§ã®æ€ã„å‡ºãŒåœ°å›³ã«é›†çµã—ã¦ã„ã¾ã™ï¼</p>

<div id="all-map" style="height: 70vh; width: 100%; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background-color: #eee;"></div>

<script>
  function initMap() {
    // 1. Pythonã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã®å¤‰æ•°ã«æ ¼ç´
    const items = {{ items | tojson | safe }};
    console.log("æ€ã„å‡ºãƒ‡ãƒ¼ã‚¿:", items); // ãƒ–ãƒ©ã‚¦ã‚¶ã®F12é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§ç¢ºèªã§ãã¾ã™

    // 2. åœ°å›³ã®åˆæœŸä¸­å¿ƒï¼ˆæ€ã„å‡ºãŒãªã„å ´åˆã¯æ±äº¬é§…ä»˜è¿‘ï¼‰
    let center = { lat: 35.6812, lng: 139.7671 };
    
    // 3. æ€ã„å‡ºãŒã‚ã‚‹å ´åˆã€ä¸€ç•ªæ–°ã—ã„æ€ã„å‡ºã‚’åœ°å›³ã®ä¸­å¿ƒã«ã™ã‚‹
    if (items.length > 0 && items[0].lat && items[0].lng) {
      center = { lat: parseFloat(items[0].lat), lng: parseFloat(items[0].lng) };
    }
    const map = new google.maps.Map(document.getElementById("all-map"), {
        zoom: 12,
        center: center,
        // â˜…æ‰‹æ›¸ããƒãƒƒãƒ—é¢¨ã®é…è‰²
        styles: [
        { "featureType": "landscape", "stylers": [{ "color": "#f1f8e9" }] }, // è‰åŸï¼ˆè–„ç·‘ï¼‰
        { "featureType": "water", "stylers": [{ "color": "#b3e5fc" }] },     // æ¹–ãƒ»æµ·ï¼ˆæ°´è‰²ï¼‰
        { "featureType": "poi.park", "stylers": [{ "color": "#c8e6c9" }] },  // æ£®ï¼ˆç·‘ï¼‰
        { "featureType": "road", "elementType": "geometry", "stylers": [{ "color": "#ffffff" }] }, // é“ï¼ˆç™½ï¼‰
        { "featureType": "poi", "stylers": [{ "visibility": "off" }] },      // ãŠåº—ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¶ˆã—ã¦è‡ªç„¶ã‚’å‡ºã™
        { "elementType": "labels.text.fill", "stylers": [{ "color": "#795548" }] } // æ–‡å­—ã‚’æ¿ƒã„èŒ¶è‰²ã«
        ],
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
    });


    // 4. å„æ€ã„å‡ºã«ãƒ”ãƒ³ï¼ˆãƒãƒ¼ã‚«ãƒ¼ï¼‰ã‚’ç«‹ã¦ã‚‹
// 4. å„æ€ã„å‡ºã«ãƒ”ãƒ³ï¼ˆãƒãƒ¼ã‚«ãƒ¼ï¼‰ã‚’ç«‹ã¦ã‚‹
    items.forEach(item => {
      if (item.lat && item.lng) {
        // â˜…ã“ã“ã‹ã‚‰ï¼šæ–°ã—ã„ã€Œã—ãšãå‹ã€ãƒ”ãƒ³ã®ãƒ‡ã‚¶ã‚¤ãƒ³å®šç¾©
        // pinColor ã‚’ã‚¸ãƒ–ãƒªã®æ£®ã£ã½ã„ç·‘è‰²ã«å¤‰æ›´
        const pinColor = "#4E7055"; // æ£®ã®æ·±ç·‘
        const svgMarker = {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="50" viewBox="0 0 40 50">
                    <path d="M20 0C8.95 0 0 8.95 0 20c0 15.4 20 30 20 30s20-14.6 20-30c0-11.05-8.95-20-20-20z" fill="${pinColor}"/>
                    <circle cx="20" cy="20" r="13" fill="#FFF9C4"/>
                    <text x="20" y="27" font-size="18" text-anchor="middle">ğŸƒ</text>
                </svg>
            `),
            scaledSize: new google.maps.Size(40, 50),
            anchor: new google.maps.Point(20, 50)
        };

        const marker = new google.maps.Marker({
          position: { lat: parseFloat(item.lat), lng: parseFloat(item.lng) },
          map: map,
          title: item.title,
          icon: svgMarker, // â˜…ã“ã“ã§æ–°ã—ã„ãƒ”ãƒ³ã‚’é©ç”¨ï¼
          animation: google.maps.Animation.DROP
        });
        // â˜…ã“ã“ã¾ã§

        // å¹ãå‡ºã—ï¼ˆInfoWindowï¼‰ã®è¨­å®š
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="padding: 10px; max-width: 220px; color: #333;">
              <h3 style="margin: 0 0 5px 0; font-size: 1.1rem; color: #FF5A5F;">${item.title}</h3>
              <p style="font-size: 0.8rem; color: #999; margin-bottom: 8px;">ğŸ“… ${item.date}</p>
              ${item.image_url ? `<img src="${item.image_url}" style="width: 100%; border-radius: 8px; margin-bottom: 8px;">` : ''}
              <p style="font-size: 0.85rem; background: #f9f9f9; padding: 5px; border-radius: 4px;">${item.note || 'ãƒ¡ãƒ¢ãªã—'}</p>
              <p style="font-size: 0.7rem; margin-top: 5px; color: #666;">ğŸ“ ${item.shop_name || ''}</p>
            </div>
          `
        });

        marker.addListener("click", () => {
          infoWindow.open(map, marker);
        });
      }
    });
  }
</script>

<script async src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap"></script>

<div style="margin-top: 20px; text-align: center;">
    <a href="/memories" style="text-decoration: none; color: #FF5A5F; font-weight: bold;">â† ä¸€è¦§ãƒªã‚¹ãƒˆã§è¦‹ãŸã„æ–¹ã¯ã“ã¡ã‚‰</a>
</div>
{% endblock %}